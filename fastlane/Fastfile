default_platform(:ios)

platform :ios do
  desc "Build and upload a new beta build to TestFlight"
  lane :beta do
    # 1️⃣ Crea aquí la API Key
    api_key = app_store_connect_api_key(
      key_id:     ENV['APP_STORE_CONNECT_API_KEY_KEY_ID'],
      issuer_id:  ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'].gsub("\\n", "\n")
    )

    # 2️⃣ Usa esa key en match
    match(
      type:    "appstore",
      api_key: api_key
    )

    # 3️⃣ instala pods y compila
    cocoapods
    build_app(
      workspace:     "ios/MyNewApp.xcworkspace",
      scheme:        "MyNewApp",
      export_method: "app-store",
      clean:         true
    )

    # 4️⃣ sube a TestFlight
    upload_to_testflight(api_key: api_key)
  end
end
