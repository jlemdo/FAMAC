default_platform(:ios)

platform :ios do
  lane :beta do
    # 1️⃣  Crea el objeto api_key usando los secrets
    api_key = app_store_connect_api_key(
      key_id:     ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id:  ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"].gsub("\\n", "\n")
    )

    # 2️⃣  Invoca match con la opción `api_key: api_key`
    match(
      type:    "appstore",
      api_key: api_key
    )

    # 3️⃣  Resto de tu lane
    cocoapods
    build_app(
      workspace: "ios/MyNewApp.xcworkspace",
      scheme:    "MyNewApp",
      export_method: "app-store",
      clean:      true
    )
    upload_to_testflight(api_key: api_key)
  end
end
